<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraud Detection Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background: #f8f9fa; 
            min-height: 100vh; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #000;
        }
        .card { 
            border: 1px solid #dee2e6; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            background: #fff;
        }
        .btn-primary { 
            background: #000; 
            border: 1px solid #000; 
            padding: 12px 30px;
            font-weight: 600;
            color: #fff;
        }
        .btn-primary:hover {
            background: #333;
            border-color: #333;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .btn-outline-primary {
            border: 1px solid #000;
            color: #000;
        }
        .btn-outline-primary:hover {
            background: #000;
            color: #fff;
        }
        .fraud-row { 
            background-color: #f8f9fa; 
            border-left: 4px solid #000;
        }
        .normal-row { 
            background-color: #fff; 
            border-left: 4px solid #6c757d;
        }
        .metrics-card {
            background: #000;
            color: #fff;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
        }
        .table {
            min-width: 15000px; /* Wide enough for all columns */
            table-layout: fixed;
        }
        .table td, .table th {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
            min-width: 100px;
        }
        .fraud-info-columns {
            min-width: 120px;
        }
        .fraud-info-columns th,
        .fraud-info-columns td {
            background: #fff;
            border-right: 2px solid #dee2e6;
        }
        .feature-columns {
            min-width: 100px;
            white-space: nowrap;
        }
        .v-feature {
            font-size: 0.8em;
            color: #6c757d;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .text-primary {
            color: #000 !important;
        }
        .text-danger {
            color: #000 !important;
        }
        .text-success {
            color: #6c757d !important;
        }
        .bg-danger {
            background-color: #000 !important;
            color: #fff !important;
        }
        .bg-success {
            background-color: #6c757d !important;
            color: #fff !important;
        }
        .progress-bar {
            background-color: #000 !important;
        }
        .progress-bar.bg-success {
            background-color: #6c757d !important;
        }
        .table-dark {
            background-color: #000 !important;
            color: #fff !important;
        }
        .text-muted {
            color: #6c757d !important;
        }
        .model-info-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .performance-highlight {
            background: #e8f5e8;
            border: 1px solid #28a745;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center position-relative">
                        <button class="btn btn-outline-primary position-absolute top-0 end-0 m-3" 
                                data-bs-toggle="modal" data-bs-target="#helpModal">
                            Help
                        </button>
                        <h1 class="mb-2">Fraud Detection Dashboard</h1>
                        <p class="text-muted mb-0">Autoencoder-Based Anomaly Detection System</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="helpModalLabel">
                            Dashboard Help & Model Information
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Model Information</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Model Type:</strong> Unsupervised Autoencoder</li>
                                    <li><strong>Architecture:</strong> Deep Neural Network</li>
                                    <li><strong>Training:</strong> Only on Normal Transactions</li>
                                    <li><strong>Features:</strong> 85+ Engineered Features</li>
                                    <li><strong>Detection Method:</strong> Reconstruction Error</li>
                                </ul>
                                <p class="small text-muted">
                                    The autoencoder learns normal transaction patterns and flags anomalies as potential fraud.
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6>How to Use the Dashboard</h6>
                                <ol class="small">
                                    <li><strong>Click "Analyse Transactions":</strong> This will process all transactions</li>
                                    <li><strong>Review Results:</strong> Transactions are sorted by anomaly score (highest to lowest)</li>
                                    <li><strong>Navigate Results:</strong> Use pagination to explore flagged transactions</li>
                                    <li><strong>Focus on Top 1%:</strong> Most anomalous transactions appear first</li>
                                </ol>
                                <div class="alert alert-info small">
                                    <strong>Key Insight:</strong> The model detects subtle, multi-dimensional patterns that traditional rule-based systems might miss.
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <h6>Understanding Autoencoder Behavior</h6>
                                <p class="small">
                                    Autoencoders identify anomalies by learning complex patterns in normal transactions. The highest anomaly scores often represent transactions with subtle, multi-dimensional anomalous patterns rather than obvious fraud indicators. This sophisticated approach enables detection of previously unseen fraud patterns.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Information Box -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="model-info-box">
                    <h5>Autoencoder Model Overview</h5>
                    <p class="mb-2">
                        This fraud detection system uses an <strong>unsupervised autoencoder</strong> that was trained exclusively on normal (non-fraudulent) transactions. 
                        The model learns to reconstruct normal transaction patterns and identifies anomalies based on reconstruction error.
                    </p>
                    <p class="mb-0">
                        <strong>Key Advantage:</strong> Unlike supervised models that require labeled fraud data, this approach can detect novel fraud patterns 
                        that weren't present in the training data, making it highly effective for real-world fraud detection scenarios.
                    </p>
                </div>
            </div>
        </div>

        <!-- Controls and Model Info -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Percentile Threshold Control</h5>
                        <div class="mb-3">
                            <label for="percentileSlider" class="form-label">Percentile Threshold: <span id="percentileValue">99</span>%</label>
                            <input type="range" class="form-range" id="percentileSlider" min="50" max="99" step="1" value="99">
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted">50% (Less Sensitive)</small>
                                <small class="text-muted">99% (Most Sensitive)</small>
                            </div>
                            <div class="mt-2 p-2 bg-light rounded">
                                <small><strong>Threshold Value:</strong> <span id="thresholdValue">Calculating...</span></small><br>
                                <small><strong>Meaning:</strong> <span id="percentileMeaning">Detecting top 99% of anomalies</span></small>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="predictButton" onclick="predictAll()">
                            Analyse Transactions
                        </button>
                        <div class="mt-2">
                            <small class="text-muted">
                                Processing time: ~10-15 seconds for complete analysis
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card metrics-card">
                    <div class="card-body">
                        <h5 class="card-title">Performance Metrics</h5>
                        <div id="metricsContent">
                            <p class="text-center text-muted">Click "Analyse Transactions" to see metrics</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Model Details</h5>
                        <div id="modelInfoContent">
                            <p class="text-center text-muted">Click "Analyse Transactions" to see model details</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Highlight -->
        <div class="row mb-4" id="performanceHighlight" style="display: none;">
            <div class="col-12">
                <div class="performance-highlight">
                    <h5>Model Performance Summary</h5>
                    <div id="performanceContent">
                        <!-- Performance content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3" id="loadingText">Processing complete test set with autoencoder model...</p>
            <div class="progress mt-3" style="height: 10px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 100%"></div>
            </div>
        </div>

        <!-- Results -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Transaction Results (Sorted by Anomaly Score)</h5>
                        <div class="pagination-info">
                            <span id="paginationInfo">Showing 0 of 0 results</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="resultsContent">
                            <p class="text-center text-muted">Click "Analyse Transactions" to see transaction results</p>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <button class="btn btn-outline-primary btn-sm" id="prevPage" onclick="previousPage()" disabled>
                                    Previous
                                </button>
                                <button class="btn btn-outline-primary btn-sm" id="nextPage" onclick="nextPage()" disabled>
                                    Next
                                </button>
                            </div>
                            <div>
                                <label for="pageSize" class="form-label me-2">Rows per page:</label>
                                <select id="pageSize" class="form-select form-select-sm d-inline-block w-auto" onchange="changePageSize()">
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables for pagination and state
        let allPredictions = [];
        let currentPage = 0;
        let pageSize = 50;
        let percentileInfo = null;

        // Update percentile display and meaning
        document.getElementById('percentileSlider').addEventListener('input', function() {
            const percentile = parseInt(this.value);
            document.getElementById('percentileValue').textContent = percentile;
            
            // Update meaning
            let meaning = '';
            if (percentile === 50) {
                meaning = 'Detecting top 50% of anomalies';
            } else if (percentile === 99) {
                meaning = 'Detecting top 99% of anomalies (most sensitive)';
            } else {
                meaning = `Detecting top ${percentile}% of anomalies`;
            }
            document.getElementById('percentileMeaning').textContent = meaning;
            
            // Update threshold value if available
            if (percentileInfo && percentileInfo.thresholds[percentile]) {
                document.getElementById('thresholdValue').textContent = percentileInfo.thresholds[percentile].toFixed(6);
            }
        });

        // Load percentile information on page load
        window.addEventListener('load', async function() {
            try {
                const response = await fetch('/api/percentiles');
                if (response.ok) {
                    percentileInfo = await response.json();
                    updatePercentileInfo();
                }
            } catch (error) {
                console.error('Error loading percentile info:', error);
            }
        });

        function updatePercentileInfo() {
            if (!percentileInfo) return;
            
            const percentile = parseInt(document.getElementById('percentileSlider').value);
            const threshold = percentileInfo.thresholds[percentile] || 'Calculating...';
            document.getElementById('thresholdValue').textContent = threshold;
        }

        async function predictAll() {
            const percentile = parseInt(document.getElementById('percentileSlider').value);
            const loading = document.getElementById('loading');
            const resultsContent = document.getElementById('resultsContent');
            const metricsContent = document.getElementById('metricsContent');
            const modelInfoContent = document.getElementById('modelInfoContent');
            const predictButton = document.getElementById('predictButton');
            
            // Disable button and show loading
            predictButton.disabled = true;
            predictButton.innerHTML = 'Processing...';
            loading.style.display = 'block';
            resultsContent.innerHTML = '';
            metricsContent.innerHTML = '';
            modelInfoContent.innerHTML = '';
            
            // Update loading message
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = `Analyzing transactions with ${percentile}% percentile threshold (this may take 10-15 seconds)...`;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 90000); // 90 second timeout
                
                const response = await fetch(`/api/predict/percentile/${percentile}`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                displayResults(result);
                
            } catch (error) {
                console.error('Error:', error);
                if (error.name === 'AbortError') {
                    alert('Request timed out. The dataset is large and may take longer to process. Please try again.');
                } else {
                    alert('Error analyzing transactions: ' + error.message);
                }
            } finally {
                // Re-enable button and hide loading
                predictButton.disabled = false;
                predictButton.innerHTML = 'Analyse Transactions';
                loading.style.display = 'none';
            }
        }

        function displayResults(result) {
            displayMetrics(result.summary, result.threshold, result.percentile);
            displayModelInfo(result);
            displayPerformanceSummary();
            displayTransactions(result.predictions);
        }

        function displayMetrics(summary, threshold, percentile) {
            const metricsContent = document.getElementById('metricsContent');
            const normal_transactions = summary.total_transactions - summary.fraud_detected;
            const flagged_rate = summary.fraud_detected / summary.total_transactions;
            
            // Get fraud rates from stats API
            fetch('/api/stats')
                .then(response => response.json())
                .then(stats => {
                    const totalFraudPercent = stats.fraud_rates?.total_dataset_fraud_percent;
                    const testFraudPercent = stats.fraud_rates?.test_set_fraud_percent;
                    const top1Percent = stats.top_1_percent_performance;
                    
                    metricsContent.innerHTML = `
                        <div class="row text-center">
                            <div class="col-6">
                                <h3>${summary.total_transactions.toLocaleString()}</h3>
                                <small>Total Transactions</small>
                            </div>
                            <div class="col-6">
                                <h3 class="text-danger">${summary.fraud_detected.toLocaleString()}</h3>
                                <small>Flagged as Fraud</small>
                            </div>
                        </div>
                        <div class="row text-center mt-3">
                            <div class="col-6">
                                <h3 class="text-success">${normal_transactions.toLocaleString()}</h3>
                                <small>Flagged as Normal</small>
                            </div>
                            <div class="col-6">
                                <h3>${(flagged_rate * 100).toFixed(1)}%</h3>
                                <small>Flagged Rate</small>
                            </div>
                        </div>
                        <div class="row text-center mt-3">
                            <div class="col-12">
                                <small><strong>Percentile:</strong> ${percentile}%</small><br>
                                <small><strong>Threshold:</strong> ${threshold.toFixed(6)}</small><br>
                                <small><strong>Accuracy:</strong> ${((summary.true_positives + summary.true_negatives) / summary.total_transactions * 100).toFixed(1)}%</small><br>
                                <small><strong>Precision:</strong> ${(top1Percent.precision * 100).toFixed(1)}%</small><br>
                                <small><strong>Recall:</strong> ${(top1Percent.recall * 100).toFixed(1)}%</small>
                            </div>
                        </div>
                        <div class="row text-center mt-3">
                            <div class="col-12">
                                <small><strong>Actual Fraud Rate:</strong></small><br>
                                <small>Test Set: ${testFraudPercent ? testFraudPercent.toFixed(3) : 'N/A'}%</small><br>
                                <small>Total Dataset: ${totalFraudPercent ? totalFraudPercent.toFixed(3) : 'N/A'}%</small>
                            </div>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error fetching fraud rates:', error);
                    // Fallback without fraud rates
                    metricsContent.innerHTML = `
                        <div class="row text-center">
                            <div class="col-6">
                                <h3>${summary.total_transactions.toLocaleString()}</h3>
                                <small>Total Transactions</small>
                            </div>
                            <div class="col-6">
                                <h3 class="text-danger">${summary.fraud_detected.toLocaleString()}</h3>
                                <small>Fraud Detected</small>
                            </div>
                        </div>
                        <div class="row text-center mt-3">
                            <div class="col-6">
                                <h3 class="text-success">${normal_transactions.toLocaleString()}</h3>
                                <small>Normal Transactions</small>
                            </div>
                            <div class="col-6">
                                <h3>${(flagged_rate * 100).toFixed(1)}%</h3>
                                <small>Flagged Rate</small>
                            </div>
                        </div>
                        <div class="row text-center mt-3">
                            <div class="col-12">
                                <small><strong>Percentile:</strong> ${percentile}%</small><br>
                                <small><strong>Threshold:</strong> ${threshold.toFixed(6)}</small><br>
                                <small><strong>Accuracy:</strong> ${((summary.true_positives + summary.true_negatives) / summary.total_transactions * 100).toFixed(1)}%</small>
                            </div>
                        </div>
                    `;
                });
        }

        function displayModelInfo(result) {
            const modelInfoContent = document.getElementById('modelInfoContent');
            
            modelInfoContent.innerHTML = `
                <div class="row text-center">
                    <div class="col-12">
                        <h6 class="text-primary">Unsupervised Autoencoder</h6>
                        <small class="text-muted">Trained on Normal Transactions Only</small>
                    </div>
                </div>
                <div class="row text-center mt-2">
                    <div class="col-6">
                        <small><strong>Predictions:</strong> ${result.predictions.length}</small>
                    </div>
                    <div class="col-6">
                        <small><strong>Threshold:</strong> ${result.threshold.toFixed(6)}</small>
                    </div>
                </div>
                <div class="row text-center mt-2">
                    <div class="col-12">
                        <small><strong>Performance:</strong></small><br>
                        <small>TP: ${result.summary.true_positives}</small><br>
                        <small>FP: ${result.summary.false_positives}</small><br>
                        <small>TN: ${result.summary.true_negatives}</small><br>
                        <small>FN: ${result.summary.false_negatives}</small>
                    </div>
                </div>
                <div class="row text-center mt-2">
                    <div class="col-12">
                        <small><strong>Current Percentile:</strong> ${result.percentile}%</small><br>
                        <small><strong>Fraud Detected:</strong> ${result.summary.fraud_detected}</small><br>
                        <small><strong>Actual Fraud:</strong> ${result.summary.actual_fraud}</small>
                    </div>
                </div>
            `;
        }

        function displayPerformanceSummary() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(stats => {
                    const top1Percent = stats.top_1_percent_performance;
                    const testFraudPercent = stats.fraud_rates?.test_set_fraud_percent;
                    
                    const performanceContent = document.getElementById('performanceContent');
                    const performanceHighlight = document.getElementById('performanceHighlight');
                    
                    performanceContent.innerHTML = `
                        <p class="mb-2">
                            <strong>In the test set of ${stats.total_transactions ? stats.total_transactions.toLocaleString() : '28,000+'} rows, 
                            if we look at the top 1 percent of anomaly scores we catch ${top1Percent.true_positives} fraud cases and missed ${top1Percent.false_negatives} fraud cases.</strong>
                        </p>
                        <p class="mb-2">
                            Fraud cases are extremely rare in this synthetic Kaggle dataset, there is about 1.3 ground truth frauds per 1000 rows (0.13%).
                        </p>
                        <p class="mb-2">
                            There were ${top1Percent.false_positives} false positives in the top 1% flagged transactions. 
                            With proper dataset-specific, subject matter expert-driven feature engineering, this performance could be enhanced even further.
                        </p>
                        <p class="mb-2">
                            The 99th percentile is selected by default in the slider. Click on analyse transaction then paginate with the next button at the bottom of the screen a few times and you will start to see the ground truth frauds. The rows with high anomaly scores that are not actually frauds is a classic problem with autoencoders if the feature engineering isn't perfect.
                        </p>
                        <p class="mb-0">
                            The focus of this project was on modular design, production readiness, and deployment, rather than feature engineering - which is more applicable to real world datasets.
                        </p>
                    `;
                    
                    performanceHighlight.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching performance stats:', error);
                });
        }

        function displayTransactions(predictions) {
            const resultsContent = document.getElementById('resultsContent');
            
            if (predictions.length === 0) {
                resultsContent.innerHTML = '<p class="text-center text-muted">No transactions to display</p>';
                return;
            }
            
            // Store all predictions globally and reset pagination
            allPredictions = predictions;
            currentPage = 0;
            
            // Display first page
            displayCurrentPage();
        }

        function displayCurrentPage() {
            const resultsContent = document.getElementById('resultsContent');
            const startIndex = currentPage * pageSize;
            const endIndex = Math.min(startIndex + pageSize, allPredictions.length);
            const currentPagePredictions = allPredictions.slice(startIndex, endIndex);
            
            const tableHtml = `
                <div class="table-container">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <!-- Fraud Info Columns (Sticky Left) -->
                                <th class="fraud-info-columns">Rank</th>
                                <th class="fraud-info-columns">Transaction ID</th>
                                <th class="fraud-info-columns">Amount ($)</th>
                                <th class="fraud-info-columns">Time (s)</th>
                                <th class="fraud-info-columns">Anomaly Score</th>
                                <th class="fraud-info-columns">Fraud Probability</th>
                                <th class="fraud-info-columns">Predicted</th>
                                <th class="fraud-info-columns">Actual</th>
                                <!-- PCA Features (V1-V28) -->
                                <th class="feature-columns">V1</th>
                                <th class="feature-columns">V2</th>
                                <th class="feature-columns">V3</th>
                                <th class="feature-columns">V4</th>
                                <th class="feature-columns">V5</th>
                                <th class="feature-columns">V6</th>
                                <th class="feature-columns">V7</th>
                                <th class="feature-columns">V8</th>
                                <th class="feature-columns">V9</th>
                                <th class="feature-columns">V10</th>
                                <th class="feature-columns">V11</th>
                                <th class="feature-columns">V12</th>
                                <th class="feature-columns">V13</th>
                                <th class="feature-columns">V14</th>
                                <th class="feature-columns">V15</th>
                                <th class="feature-columns">V16</th>
                                <th class="feature-columns">V17</th>
                                <th class="feature-columns">V18</th>
                                <th class="feature-columns">V19</th>
                                <th class="feature-columns">V20</th>
                                <th class="feature-columns">V21</th>
                                <th class="feature-columns">V22</th>
                                <th class="feature-columns">V23</th>
                                <th class="feature-columns">V24</th>
                                <th class="feature-columns">V25</th>
                                <th class="feature-columns">V26</th>
                                <th class="feature-columns">V27</th>
                                <th class="feature-columns">V28</th>
                                <!-- Professional Business Features -->
                                <th class="feature-columns">Amount (Log)</th>
                                <th class="feature-columns">Amount (Sqrt)</th>
                                <th class="feature-columns">Amount (Scaled)</th>
                                <th class="feature-columns">Above 95th %</th>
                                <th class="feature-columns">Ratio to Median</th>
                                <th class="feature-columns">Hour</th>
                                <th class="feature-columns">Day of Week</th>
                                <th class="feature-columns">Weekend</th>
                                <th class="feature-columns">Business Hours</th>
                                <th class="feature-columns">Risk Score</th>
                                <th class="feature-columns">High Risk</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentPagePredictions.map((pred, index) => {
                                const rowClass = pred.actual_fraud ? 'fraud-row' : 'normal-row';
                                const predictedBadgeClass = pred.predicted_fraud ? 'bg-danger' : 'bg-success';
                                const predictedBadgeText = pred.predicted_fraud ? 'FRAUD' : 'NORMAL';
                                const actualBadgeClass = pred.actual_fraud ? 'bg-danger' : 'bg-success';
                                const actualBadgeText = pred.actual_fraud ? 'FRAUD' : 'NORMAL';
                                const rank = startIndex + index + 1;
                                
                                // Get engineered features - ensure we get all features from the prediction
                                const features = pred.engineered_features || {};
                                
                                // Helper function to safely get feature value
                                const getFeatureValue = (featureName) => {
                                    const value = features[featureName];
                                    if (value === undefined || value === null) return 0;
                                    return parseFloat(value) || 0;
                                };
                                
                                return `
                                    <tr class="${rowClass}">
                                        <!-- Fraud Info Columns (Sticky Left) -->
                                        <td class="fraud-info-columns"><strong>#${rank}</strong></td>
                                        <td class="fraud-info-columns"><strong>${pred.transaction_id}</strong></td>
                                        <td class="fraud-info-columns">$${pred.amount.toFixed(2)}</td>
                                        <td class="fraud-info-columns">${pred.time.toFixed(0)}</td>
                                        <td class="fraud-info-columns"><strong class="text-primary">${pred.anomaly_score.toFixed(6)}</strong></td>
                                        <td class="fraud-info-columns">
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar ${pred.predicted_fraud ? 'bg-danger' : 'bg-success'}" 
                                                     style="width: ${Math.min(pred.fraud_probability, 100)}%">
                                                    ${pred.fraud_probability.toFixed(1)}%
                                                </div>
                                            </div>
                                        </td>
                                        <td class="fraud-info-columns"><span class="badge ${predictedBadgeClass}">${predictedBadgeText}</span></td>
                                        <td class="fraud-info-columns"><span class="badge ${actualBadgeClass}">${actualBadgeText}</span></td>
                                        <!-- PCA Features (V1-V28) -->
                                        <td class="feature-columns v-feature">${getFeatureValue('v1').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v2').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v3').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v4').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v5').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v6').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v7').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v8').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v9').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v10').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v11').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v12').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v13').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v14').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v15').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v16').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v17').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v18').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v19').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v20').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v21').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v22').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v23').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v24').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v25').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v26').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v27').toFixed(3)}</td>
                                        <td class="feature-columns v-feature">${getFeatureValue('v28').toFixed(3)}</td>
                                        <!-- Professional Business Features -->
                                        <td class="feature-columns">${getFeatureValue('amount_log').toFixed(3)}</td>
                                        <td class="feature-columns">${getFeatureValue('amount_sqrt').toFixed(3)}</td>
                                        <td class="feature-columns">${getFeatureValue('amount_scaled').toFixed(3)}</td>
                                        <td class="feature-columns">${getFeatureValue('amount_above_95').toFixed(3)}</td>
                                        <td class="feature-columns">${getFeatureValue('amount_ratio_to_median').toFixed(3)}</td>
                                        <td class="feature-columns">${getFeatureValue('hour').toFixed(3)}</td>
                                        <td class="feature-columns">${getFeatureValue('day_of_week').toFixed(3)}</td>
                                        <td class="feature-columns">${getFeatureValue('is_weekend').toFixed(3)}</td>
                                        <td class="feature-columns">${getFeatureValue('is_business_hours').toFixed(3)}</td>
                                        <td class="feature-columns">${getFeatureValue('comprehensive_risk_score').toFixed(3)}</td>
                                        <td class="feature-columns">${getFeatureValue('high_risk').toFixed(3)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            resultsContent.innerHTML = tableHtml;
            
            // Update pagination info and buttons
            updatePaginationInfo();
            updatePaginationButtons();
        }

        function updatePaginationInfo() {
            const paginationInfo = document.getElementById('paginationInfo');
            const startIndex = currentPage * pageSize + 1;
            const endIndex = Math.min((currentPage + 1) * pageSize, allPredictions.length);
            paginationInfo.textContent = `Showing ${startIndex}-${endIndex} of ${allPredictions.length} results`;
        }

        function updatePaginationButtons() {
            const prevButton = document.getElementById('prevPage');
            const nextButton = document.getElementById('nextPage');
            
            prevButton.disabled = currentPage === 0;
            nextButton.disabled = (currentPage + 1) * pageSize >= allPredictions.length;
        }

        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                displayCurrentPage();
            }
        }

        function nextPage() {
            if ((currentPage + 1) * pageSize < allPredictions.length) {
                currentPage++;
                displayCurrentPage();
            }
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 0;
            displayCurrentPage();
        }
    </script>
</body>
</html> 