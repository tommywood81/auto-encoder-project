<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autoencoder Fraud Detection Demo</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .title {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            font-size: 1.1em;
            font-weight: 600;
            color: #6c757d;
        }

        .tab.active {
            background: white;
            color: #3498db;
            border-bottom: 3px solid #3498db;
        }

        .tab:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        .predict-button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .predict-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .predict-button:active {
            transform: translateY(-1px);
        }

        .results {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 15px;
            border-left: 5px solid #3498db;
        }

        .results.show {
            display: block;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .metric-value {
            font-weight: 700;
            color: #3498db;
            font-size: 1.1em;
        }

        .loading {
            display: none;
            margin-top: 20px;
            text-align: center;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            display: none;
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #e74c3c;
        }

        .error.show {
            display: block;
        }

        .visualization-container {
            margin-top: 30px;
            text-align: center;
        }

        .plot-container {
            width: 100%;
            height: 600px;
            margin: 20px 0;
        }

        .info-box {
            background: rgba(52, 152, 219, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #3498db;
        }

        .info-box h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #555;
            line-height: 1.6;
        }

        .no-visualization {
            display: none;
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .no-visualization.show {
            display: block;
        }

        .viz-section {
            margin: 40px 0;
            padding: 20px;
            background: rgba(52, 152, 219, 0.05);
            border-radius: 15px;
            border-left: 5px solid #3498db;
        }

        .viz-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .viz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .viz-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .viz-item h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .viz-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .viz-item p {
            color: #555;
            font-size: 0.9em;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1 class="title">üß† Autoencoder Fraud Detection</h1>
            <p class="subtitle">Unsupervised anomaly detection for fraud prevention</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('business')">üìä Business Use</button>
            <button class="tab" onclick="switchTab('datascience')">üî¨ Data Science</button>
        </div>

        <!-- Business Use Tab -->
        <div id="business-tab" class="tab-content active">
            <div style="text-align: center;">
                <div class="info-box" style="margin-bottom: 30px;">
                    <h3>üìÖ Date Selection</h3>
                    <p>Select a specific date to analyze fraud patterns for that day, or use "All Dates" for overall analysis.</p>
                    <select id="date-selector" style="padding: 10px; margin: 10px; border-radius: 5px; border: 1px solid #ddd; font-size: 16px;">
                        <option value="All Dates">All Dates</option>
                    </select>
                </div>
                
                <button class="predict-button" onclick="runPrediction()">
                    üîç Run Prediction & Generate Visualization
                </button>
                <button class="predict-button" style="margin-left: 10px; background: linear-gradient(45deg, #27ae60, #2ecc71);" onclick="getAllColumnsTransactions()">
                    üìä View All Columns (36+ Features)
                </button>
                <button class="predict-button" style="margin-left: 10px; background: linear-gradient(45deg, #e67e22, #f39c12);" onclick="toggleFeatureImportance()" id="feature-importance-btn">
                    üß† Show Feature Importance
                </button>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Analyzing transactions and generating 3D visualization...</p>
                </div>
                
                <div class="results" id="results">
                    <h3>üìä Prediction Results</h3>
                    <div class="metric">
                        <span class="metric-label">Total Transactions:</span>
                        <span class="metric-value" id="total-transactions">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Flagged as Fraud:</span>
                        <span class="metric-value" id="flagged-transactions">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Not Flagged:</span>
                        <span class="metric-value" id="not-flagged">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">‚úÖ Actual Fraud (Caught):</span>
                        <span class="metric-value" id="flagged-actual-fraud">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">‚ö†Ô∏è False Alarms:</span>
                        <span class="metric-value" id="flagged-false-alarms">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Precision (% Correct):</span>
                        <span class="metric-value" id="precision">-</span>
                    </div>
                </div>
                
                <div class="error" id="error">
                    <p id="error-message">An error occurred while processing the request.</p>
                </div>
                
                <!-- All Columns Transactions Section -->
                <div class="all-columns-transactions" id="all-columns-transactions" style="display: none; margin-top: 30px;">
                    <h3>üìã Complete Transaction Analysis (All 36+ Columns)</h3>
                    <div class="info-box">
                        <h4>üîç Complete Data View</h4>
                        <p>This table shows every transaction with all original and engineered features. Scroll horizontally to see all columns. The Random Forest feature importance column (when enabled) shows which features contributed most to the fraud detection decision for each transaction.</p>
                    </div>
                    
                    <div class="table-container" style="overflow-x: auto; margin-top: 20px; border: 2px solid #dee2e6; border-radius: 10px; max-height: 600px; overflow-y: auto;">
                        <table id="all-columns-table" style="width: 100%; border-collapse: collapse; font-size: 12px; min-width: 2000px;">
                            <thead>
                                <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; z-index: 10;">
                                    <!-- Original Columns -->
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #e3f2fd; font-weight: bold;">Transaction ID</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #e3f2fd; font-weight: bold;">Date</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #e3f2fd; font-weight: bold;">Amount</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #e3f2fd; font-weight: bold;">Quantity</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #e3f2fd; font-weight: bold;">Customer Age</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #e3f2fd; font-weight: bold;">Account Age</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #e3f2fd; font-weight: bold;">Payment Method</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #e3f2fd; font-weight: bold;">Product Category</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #e3f2fd; font-weight: bold;">Device Used</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #e3f2fd; font-weight: bold;">Customer Location</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #e3f2fd; font-weight: bold;">Hour</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #e3f2fd; font-weight: bold;">Is Fraudulent</th>
                                    
                                    <!-- Engineered Features -->
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Amount Log</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Amount Per Item</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Payment Encoded</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Product Encoded</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Device Encoded</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Late Night</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Burst Transaction</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Amount Per Age</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Amount Per Account Age</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Age Band</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">High Amount Flag</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">New Account Flag</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Young Customer Flag</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Late Night Flag</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">High Quantity Flag</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Unusual Location Flag</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Amount Age Interaction</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Account Age Interaction</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Fraud Risk Score</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Rolling Avg Amount</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Rolling Std Amount</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Amount Rank</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Account Age Rank</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Amount √ó Hour</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #f3e5f5; font-weight: bold;">Amount Per Hour</th>
                                    
                                    <!-- Model Predictions -->
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #fff3e0; font-weight: bold;">Anomaly Score</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #fff3e0; font-weight: bold;">Autoencoder Flagged</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #fff3e0; font-weight: bold;">RF Prediction</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #fff3e0; font-weight: bold;">RF Probability</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #fff3e0; font-weight: bold;">Risk Level</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #fff3e0; font-weight: bold;">Review Priority</th>
                                    
                                    <!-- Feature Importance (hidden by default) -->
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; background-color: #e8f5e8; font-weight: bold; display: none;" id="feature-importance-header">Top Feature Importance</th>
                                </tr>
                            </thead>
                            <tbody id="all-columns-tbody">
                                <!-- Transaction rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Feature Importance Summary -->
                    <div class="info-box" style="margin-top: 20px;">
                        <h4>üìä Global Feature Importance</h4>
                        <div id="global-features-all" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            <!-- Global feature importance will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Science Tab -->
        <div id="datascience-tab" class="tab-content">
            <div class="info-box">
                <h3>üî¨ 3D Latent Space Visualization</h3>
                <p>This 3D plot shows how the autoencoder compresses transaction data into a lower-dimensional latent space using Principal Component Analysis (PCA). 
                Normal transactions cluster together while anomalous (potentially fraudulent) transactions appear as outliers. 
                You can interact with the plot by rotating, zooming, and panning to explore the data from different angles.</p>
            </div>

            <div class="info-box">
                <h3>üß† How This Works</h3>
                <p><strong>Step 1 - Data Compression:</strong> The autoencoder takes all the transaction features (like amount, time, customer age, etc.) and squeezes them down into just 16 numbers called "latent dimensions" using its encoder part. Think of it like taking a big, detailed picture and making a smaller, simpler version that still captures the important parts.</p>
                
                <p><strong>Step 2 - PCA Visualization:</strong> Since we can't easily visualize 16 dimensions, we use Principal Component Analysis (PCA) to transform all 16 dimensions into 3 dimensions. PCA finds the directions of maximum variance in the data and projects the points onto these new axes. This ensures we capture the most important patterns while making the data visualizable.</p>
                
                <p><strong>Step 3 - Finding Patterns:</strong> Normal transactions (shown in green) tend to group together in clusters, while suspicious transactions (shown in red) stand out as outliers. This happens because the autoencoder learned during training that normal transactions should be easy to reconstruct, while unusual ones are harder to predict.</p>
                
                <p><strong>Step 4 - Interactive Exploration:</strong> You can rotate the 3D plot by clicking and dragging, zoom with the scroll wheel, and pan by right-clicking and dragging. This allows you to explore the data from any angle and discover hidden patterns.</p>
            </div>

            <div class="info-box">
                <h3>üìä Comprehensive Analysis Dashboard</h3>
                <p>Below you'll find 10 different visualizations that showcase every aspect of our autoencoder fraud detection system. Each graph reveals different insights about how the model works and performs.</p>
            </div>

            <div class="no-visualization" id="no-visualization">
                <h3>üìä No Visualization Available</h3>
                <p>Please run a prediction from the Business Use tab first to generate the 3D latent space visualization.</p>
            </div>

            <div class="visualization-container" id="visualization-container">
                <div class="viz-section">
                    <h3>üéØ Interactive 3D Latent Space Visualization</h3>
                    
                    <!-- Enhanced PCA Plot -->
                    <div class="viz-item">
                        <h4>üî¨ PCA (Principal Component Analysis) Visualization</h4>
                        <div class="info-box" style="margin-bottom: 20px;">
                            <h5>Interactive Controls:</h5>
                            <ul>
                                <li><strong>Rotate:</strong> Click and drag to rotate the 3D plot</li>
                                <li><strong>Zoom:</strong> Use mouse wheel to zoom in/out</li>
                                <li><strong>Pan:</strong> Right-click and drag to pan around</li>
                                <li><strong>Reset:</strong> Double-click to reset the view</li>
                            </ul>
                        </div>
                        <div id="plot-3d" class="plot-container" style="height: 600px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"></div>
                        <div class="info-box" style="margin-top: 20px;">
                            <h5>How This Works:</h5>
                            <p>This visualization uses Principal Component Analysis (PCA) to transform all 16 latent dimensions into 3 dimensions. PCA finds the directions of maximum variance in the data and projects the points onto these new axes. The first 3 principal components capture the most important patterns in the data while making it visualizable in 3D space.</p>
                            <div id="plot-image-container" style="text-align: center; margin-top: 15px;">
                                <img id="plot-image" style="max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comprehensive Analysis Section -->
                <div class="info-box" style="margin-top: 40px;">
                    <h3>üî¨ Complete Data Science Analysis</h3>
                    <p>Click the button below to generate all 10 comprehensive visualizations that showcase every aspect of the autoencoder fraud detection system.</p>
                    <button class="predict-button" style="margin: 20px 0;" onclick="generateAllVisualizations()">
                        üöÄ Generate All Visualizations
                    </button>
                </div>

                <div class="loading" id="viz-loading">
                    <div class="spinner"></div>
                    <p>Generating comprehensive visualizations...</p>
                </div>

                <!-- Visualization Grid -->
                <div id="viz-grid" style="display: none;">
                    <div class="viz-section">
                        <h3>üìà Model Performance</h3>
                        <div class="viz-grid">
                            <div class="viz-item">
                                <h4>ROC Curve</h4>
                                <img id="roc-curve" class="viz-image" />
                                <p>Shows how well the model distinguishes between normal and fraudulent transactions at different thresholds.</p>
                            </div>
                            <div class="viz-item">
                                <h4>Confusion Matrix</h4>
                                <img id="confusion-matrix" class="viz-image" />
                                <p>Displays true positives, false positives, true negatives, and false negatives.</p>
                            </div>
                            <div class="viz-item">
                                <h4>Performance Metrics</h4>
                                <img id="performance-metrics" class="viz-image" />
                                <p>Key performance indicators including ROC AUC, precision, recall, and F1-score.</p>
                            </div>
                            <div class="viz-item">
                                <h4>Threshold Sensitivity</h4>
                                <img id="threshold-sensitivity" class="viz-image" />
                                <p>How precision and recall change as we adjust the detection threshold.</p>
                            </div>
                        </div>
                    </div>

                    <div class="viz-section">
                        <h3>üîç Model Understanding</h3>
                        <div class="viz-grid">
                            <div class="viz-item">
                                <h4>Reconstruction Error Distribution</h4>
                                <img id="reconstruction-error" class="viz-image" />
                                <p>The core mechanism: normal transactions have low reconstruction error, fraud has high error.</p>
                            </div>
                            <div class="viz-item">
                                <h4>Feature Importance</h4>
                                <img id="feature-importance" class="viz-image" />
                                <p>Which transaction features contribute most to anomaly detection.</p>
                            </div>
                            <div class="viz-item">
                                <h4>Feature Correlation Matrix</h4>
                                <img id="correlation-matrix" class="viz-image" />
                                <p>How different features relate to each other and to anomaly detection.</p>
                            </div>
                        </div>
                    </div>

                    <div class="viz-section">
                        <h3>üíº Business Insights</h3>
                        <div class="viz-grid">
                            <div class="viz-item">
                                <h4>Anomaly Score vs Transaction Amount</h4>
                                <img id="anomaly-vs-amount" class="viz-image" />
                                <p>Relationship between transaction value and fraud likelihood.</p>
                            </div>
                            <div class="viz-item">
                                <h4>Time-based Patterns</h4>
                                <img id="time-patterns" class="viz-image" />
                                <p>When during the day fraud is most likely to occur.</p>
                            </div>
                            <div class="viz-item">
                                <h4>Customer Segmentation</h4>
                                <img id="customer-segmentation" class="viz-image" />
                                <p>How fraud risk varies by customer age, account age, payment method, and product category.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // If switching to datascience tab, check for visualization
            if (tabName === 'datascience') {
                checkVisualization();
            }
        }

        async function runPrediction() {
            // Show loading
            document.getElementById('loading').classList.add('show');
            document.getElementById('results').classList.remove('show');
            document.getElementById('error').classList.remove('show');
            
            try {
                const selectedDate = document.getElementById('date-selector').value;
                
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: selectedDate,
                        threshold: null  // Use the trained threshold from YAML
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update results
                document.getElementById('total-transactions').textContent = data.metrics.total_transactions.toLocaleString();
                document.getElementById('flagged-transactions').textContent = data.metrics.flagged_transactions.toLocaleString();
                document.getElementById('not-flagged').textContent = data.metrics.not_flagged.toLocaleString();
                document.getElementById('flagged-actual-fraud').textContent = data.metrics.flagged_actual_fraud.toLocaleString();
                document.getElementById('flagged-false-alarms').textContent = data.metrics.flagged_false_alarms.toLocaleString();
                document.getElementById('precision').textContent = `${data.metrics.precision.toFixed(1)}%`;
                
                // Show results
                document.getElementById('results').classList.add('show');
                
                // Generate 3D visualization
                await generateVisualization();
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('error-message').textContent = `Error: ${error.message}`;
                document.getElementById('error').classList.add('show');
            } finally {
                // Hide loading
                document.getElementById('loading').classList.remove('show');
            }
        }

        async function generateVisualization() {
            try {
                const response = await fetch('/api/generate-3d-plot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('PCA 3D visualization generated successfully');
                } else {
                    console.error('Failed to generate visualization:', data.error);
                }
                
            } catch (error) {
                console.error('Error generating visualization:', error);
            }
        }

        async function checkVisualization() {
            try {
                const response = await fetch('/api/check-visualization');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.available) {
                        // Load and display the plot
                        loadVisualization();
                    } else {
                        // Show no visualization message
                        document.getElementById('visualization-container').style.display = 'none';
                        document.getElementById('no-visualization').classList.add('show');
                    }
                } else {
                    document.getElementById('visualization-container').style.display = 'none';
                    document.getElementById('no-visualization').classList.add('show');
                }
                
            } catch (error) {
                console.error('Error checking visualization:', error);
                document.getElementById('visualization-container').style.display = 'none';
                document.getElementById('no-visualization').classList.add('show');
            }
        }

        async function loadVisualization() {
            try {
                // Load PCA plot
                const response = await fetch('/api/get-3d-plot-data');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Create enhanced 3D scatter plot for PCA
                    const trace1 = {
                        x: data.normal.x,
                        y: data.normal.y,
                        z: data.normal.z,
                        mode: 'markers',
                        type: 'scatter3d',
                        name: 'Normal Transactions',
                        marker: {
                            size: 5,
                            color: '#2E8B57', // Sea Green
                            opacity: 0.7,
                            line: {
                                color: '#ffffff',
                                width: 0.5
                            }
                        },
                        hovertemplate: '<b>Normal Transaction</b><br>' +
                                      'PC1: %{x:.3f}<br>' +
                                      'PC2: %{y:.3f}<br>' +
                                      'PC3: %{z:.3f}<br>' +
                                      '<extra></extra>'
                    };

                    const trace2 = {
                        x: data.anomalous.x,
                        y: data.anomalous.y,
                        z: data.anomalous.z,
                        mode: 'markers',
                        type: 'scatter3d',
                        name: 'Anomalous Transactions',
                        marker: {
                            size: 7,
                            color: '#DC143C', // Crimson Red
                            opacity: 0.9,
                            line: {
                                color: '#ffffff',
                                width: 0.5
                            }
                        },
                        hovertemplate: '<b>Anomalous Transaction</b><br>' +
                                      'PC1: %{x:.3f}<br>' +
                                      'PC2: %{y:.3f}<br>' +
                                      'PC3: %{z:.3f}<br>' +
                                      '<extra></extra>'
                    };

                    const layout = {
                        title: {
                            text: `3D Latent Space Visualization (PCA)<br><sub>Explained Variance: ${(data.metadata.total_explained_variance * 100).toFixed(1)}%</sub>`,
                            font: {
                                size: 18,
                                color: '#2c3e50'
                            }
                        },
                        scene: {
                            xaxis: { 
                                title: 'Principal Component 1',
                                titlefont: { size: 14, color: '#2c3e50' },
                                tickfont: { size: 12 },
                                gridcolor: '#E0E0E0',
                                zerolinecolor: '#E0E0E0',
                                showbackground: true,
                                backgroundcolor: 'rgba(248, 249, 250, 0.1)'
                            },
                            yaxis: { 
                                title: 'Principal Component 2',
                                titlefont: { size: 14, color: '#2c3e50' },
                                tickfont: { size: 12 },
                                gridcolor: '#E0E0E0',
                                zerolinecolor: '#E0E0E0',
                                showbackground: true,
                                backgroundcolor: 'rgba(248, 249, 250, 0.1)'
                            },
                            zaxis: { 
                                title: 'Principal Component 3',
                                titlefont: { size: 14, color: '#2c3e50' },
                                tickfont: { size: 12 },
                                gridcolor: '#E0E0E0',
                                zerolinecolor: '#E0E0E0',
                                showbackground: true,
                                backgroundcolor: 'rgba(248, 249, 250, 0.1)'
                            },
                            camera: {
                                eye: {
                                    x: 1.5,
                                    y: 1.5,
                                    z: 1.5
                                }
                            }
                        },
                        width: 900,
                        height: 600,
                        margin: {
                            l: 0,
                            r: 0,
                            b: 0,
                            t: 80
                        },
                        showlegend: true,
                        legend: {
                            x: 0.02,
                            y: 0.98,
                            bgcolor: 'rgba(255, 255, 255, 0.9)',
                            bordercolor: '#E0E0E0',
                            borderwidth: 1,
                            font: { size: 12 }
                        },
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)'
                    };

                    const config = {
                        displayModeBar: true,
                        displaylogo: false,
                        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                        modeBarButtonsToAdd: [{
                            name: 'Reset View',
                            icon: Plotly.Icons.home,
                            click: function() {
                                Plotly.relayout('plot-3d', {
                                    'scene.camera.eye': {x: 1.5, y: 1.5, z: 1.5}
                                });
                            }
                        }]
                    };

                    Plotly.newPlot('plot-3d', [trace1, trace2], layout, config);
                    
                    // Load the static plot image
                    const image = document.getElementById('plot-image');
                    if (image) {
                        image.src = '/api/get-3d-plot-image?' + new Date().getTime();
                        image.onload = function() {
                            console.log('Plot image loaded successfully');
                        };
                        image.onerror = function() {
                            console.log('Plot image not available');
                            document.getElementById('plot-image-container').style.display = 'none';
                        };
                    }
                }
                
                // Show visualization
                document.getElementById('visualization-container').style.display = 'block';
                document.getElementById('no-visualization').classList.remove('show');
                
            } catch (error) {
                console.error('Error loading visualization:', error);
                document.getElementById('visualization-container').style.display = 'none';
                document.getElementById('no-visualization').classList.add('show');
            }
        }

        // Load available dates when page loads
        async function loadAvailableDates() {
            try {
                const response = await fetch('/available-dates');
                
                if (response.ok) {
                    const data = await response.json();
                    const dateSelector = document.getElementById('date-selector');
                    
                    // Clear existing options except "All Dates"
                    dateSelector.innerHTML = '<option value="All Dates">All Dates</option>';
                    
                    // Add date options
                    data.dates.forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = date;
                        dateSelector.appendChild(option);
                    });
                    
                    console.log(`Loaded ${data.dates.length} available dates`);
                } else {
                    console.error('Failed to load available dates');
                }
                
            } catch (error) {
                console.error('Error loading available dates:', error);
            }
        }

        // Check for visualization when page loads
        window.onload = function() {
            loadAvailableDates();
            if (document.getElementById('datascience-tab').classList.contains('active')) {
                checkVisualization();
            }
        };

        async function getDetailedTransactions() {
            // Show loading
            document.getElementById('loading').classList.add('show');
            document.getElementById('detailed-transactions').style.display = 'none';
            document.getElementById('error').classList.remove('show');
            
            try {
                const selectedDate = document.getElementById('date-selector').value;
                
                const response = await fetch('/api/detailed-transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: selectedDate,
                        threshold: null
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Populate the transactions table
                const tbody = document.getElementById('transactions-tbody');
                tbody.innerHTML = '';
                
                data.transactions.forEach((transaction, index) => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #dee2e6';
                    row.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    
                    // Color code based on risk level
                    if (transaction.risk_level === 'High') {
                        row.style.backgroundColor = '#fff5f5';
                    } else if (transaction.risk_level === 'Medium') {
                        row.style.backgroundColor = '#fffbf0';
                    }
                    
                    // Create top features display
                    const topFeatures = transaction.top_features.map(f => 
                        `${f.feature}: ${(f.importance * 100).toFixed(1)}%`
                    ).join('<br>');
                    
                    row.innerHTML = `
                        <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">${transaction.transaction_id}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6;">${transaction.customer_id}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold; color: ${transaction.transaction_amount > 1000 ? '#dc3545' : '#28a745'};">$${transaction.transaction_amount.toFixed(2)}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6;">${transaction.merchant_category}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6;">${transaction.payment_method}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold; color: ${transaction.anomaly_score > 0.8 ? '#dc3545' : transaction.anomaly_score > 0.5 ? '#ffc107' : '#28a745'};">${(transaction.anomaly_score * 100).toFixed(1)}%</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6;">
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; 
                                background-color: ${transaction.risk_level === 'High' ? '#dc3545' : transaction.risk_level === 'Medium' ? '#ffc107' : '#28a745'}; 
                                color: white;">
                                ${transaction.risk_level}
                            </span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #dee2e6; font-size: 12px; max-width: 200px;">${topFeatures}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6;">
                            <button onclick="showFeatureDetails(${index})" style="padding: 4px 8px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                View Details
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // Populate global feature importance
                const globalFeaturesDiv = document.getElementById('global-features');
                globalFeaturesDiv.innerHTML = '';
                
                data.feature_importance_summary.top_global_features.forEach(feature => {
                    const featureDiv = document.createElement('div');
                    featureDiv.style.padding = '10px';
                    featureDiv.style.backgroundColor = '#f8f9fa';
                    featureDiv.style.borderRadius = '5px';
                    featureDiv.style.border = '1px solid #dee2e6';
                    featureDiv.innerHTML = `
                        <strong>${feature.feature}</strong><br>
                        <span style="color: #6c757d;">${(feature.importance * 100).toFixed(1)}% importance</span>
                    `;
                    globalFeaturesDiv.appendChild(featureDiv);
                });
                
                // Show detailed transactions section
                document.getElementById('detailed-transactions').style.display = 'block';
                
                // Store transaction data for detail view
                window.transactionData = data.transactions;
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('error-message').textContent = `Error: ${error.message}`;
                document.getElementById('error').classList.add('show');
            } finally {
                // Hide loading
                document.getElementById('loading').classList.remove('show');
            }
        }

        function showFeatureDetails(transactionIndex) {
            const transaction = window.transactionData[transactionIndex];
            if (!transaction) return;
            
            // Create modal content
            let modalContent = `
                <div style="max-width: 800px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">Transaction Details: ${transaction.transaction_id}</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h4 style="color: #495057;">Transaction Information</h4>
                            <p><strong>Customer ID:</strong> ${transaction.customer_id}</p>
                            <p><strong>Amount:</strong> $${transaction.transaction_amount.toFixed(2)}</p>
                            <p><strong>Merchant:</strong> ${transaction.merchant_category}</p>
                            <p><strong>Payment Method:</strong> ${transaction.payment_method}</p>
                            <p><strong>Customer Age:</strong> ${transaction.customer_age}</p>
                            <p><strong>Account Age:</strong> ${transaction.account_age_days} days</p>
                        </div>
                        <div>
                            <h4 style="color: #495057;">Risk Assessment</h4>
                            <p><strong>Anomaly Score:</strong> ${(transaction.anomaly_score * 100).toFixed(1)}%</p>
                            <p><strong>Risk Level:</strong> <span style="color: ${transaction.risk_level === 'High' ? '#dc3545' : transaction.risk_level === 'Medium' ? '#ffc107' : '#28a745'}; font-weight: bold;">${transaction.risk_level}</span></p>
                            <p><strong>Review Priority:</strong> ${transaction.review_priority}</p>
                            <p><strong>Autoencoder Flagged:</strong> ${transaction.autoencoder_flagged ? 'Yes' : 'No'}</p>
                            <p><strong>RF Prediction:</strong> ${transaction.rf_prediction ? 'Fraud' : 'Normal'}</p>
                            <p><strong>RF Probability:</strong> ${(transaction.rf_probability * 100).toFixed(1)}%</p>
                        </div>
                    </div>
                    
                    <h4 style="color: #495057; margin-bottom: 15px;">Feature Importance Analysis</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Feature</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Importance</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Value</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Impact</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Sort features by importance
            const sortedFeatures = Object.entries(transaction.all_features)
                .sort(([,a], [,b]) => b.importance - a.importance);
            
            sortedFeatures.forEach(([featureName, featureData]) => {
                const importancePercent = (featureData.importance * 100).toFixed(1);
                const impact = featureData.importance > 0.1 ? 'High' : featureData.importance > 0.05 ? 'Medium' : 'Low';
                const impactColor = impact === 'High' ? '#dc3545' : impact === 'Medium' ? '#ffc107' : '#28a745';
                
                modalContent += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: bold;">${featureName}</td>
                        <td style="padding: 10px; border: 1px solid #dee2e6;">${importancePercent}%</td>
                        <td style="padding: 10px; border: 1px solid #dee2e6;">${featureData.value.toFixed(4)}</td>
                        <td style="padding: 10px; border: 1px solid #dee2e6;">
                            <span style="color: ${impactColor}; font-weight: bold;">${impact}</span>
                        </td>
                    </tr>
                `;
            });
            
            modalContent += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="closeModal()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            // Show modal
            const modal = document.createElement('div');
            modal.id = 'feature-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
        }

        function closeModal() {
            const modal = document.getElementById('feature-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function generateAllVisualizations() {
            // Show loading
            document.getElementById('viz-loading').classList.add('show');
            document.getElementById('viz-grid').style.display = 'none';
            
            try {
                const response = await fetch('/api/generate-all-visualizations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('All visualizations generated successfully');
                    
                    // Load all visualization images
                    const vizTypes = [
                        'roc-curve', 'confusion-matrix', 'performance-metrics', 'threshold-sensitivity',
                        'reconstruction-error', 'feature-importance', 'correlation-matrix',
                        'anomaly-vs-amount', 'time-patterns', 'customer-segmentation'
                    ];
                    
                    const vizMapping = {
                        'roc-curve': 'roc_curve',
                        'confusion-matrix': 'confusion_matrix',
                        'performance-metrics': 'performance_metrics',
                        'threshold-sensitivity': 'threshold_sensitivity',
                        'reconstruction-error': 'reconstruction_error',
                        'feature-importance': 'feature_importance',
                        'correlation-matrix': 'correlation_matrix',
                        'anomaly-vs-amount': 'anomaly_vs_amount',
                        'time-patterns': 'time_patterns',
                        'customer-segmentation': 'customer_segmentation'
                    };
                    
                    // Load each visualization
                    for (const vizId of vizTypes) {
                        const imgElement = document.getElementById(vizId);
                        if (imgElement) {
                            imgElement.src = `/api/get-visualization/${vizMapping[vizId]}?${new Date().getTime()}`;
                            imgElement.onerror = function() {
                                console.log(`Failed to load ${vizId}`);
                                this.style.display = 'none';
                            };
                        }
                    }
                    
                    // Show the visualization grid
                    document.getElementById('viz-grid').style.display = 'block';
                    
                } else {
                    console.error('Failed to generate visualizations:', data.error);
                    alert('Failed to generate visualizations: ' + data.error);
                }
                
            } catch (error) {
                console.error('Error generating visualizations:', error);
                alert('Error generating visualizations: ' + error.message);
            } finally {
                // Hide loading
                document.getElementById('viz-loading').classList.remove('show');
            }
        }

        async function getAllColumnsTransactions() {
            // Show loading
            document.getElementById('loading').classList.add('show');
            document.getElementById('all-columns-transactions').style.display = 'none';
            document.getElementById('error').classList.remove('show');
            
            try {
                const selectedDate = document.getElementById('date-selector').value;
                
                const response = await fetch('/api/all-columns-transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: selectedDate,
                        threshold: null
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Populate the all-columns-table
                const tbody = document.getElementById('all-columns-tbody');
                tbody.innerHTML = '';
                
                data.transactions.forEach((transaction, index) => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #dee2e6';
                    row.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    
                    // Color code based on fraud status and risk level
                    if (transaction.is_fraudulent) {
                        row.style.backgroundColor = '#fff5f5';
                        row.style.borderLeft = '4px solid #dc3545';
                    } else if (transaction.autoencoder_flagged) {
                        row.style.backgroundColor = '#fffbf0';
                        row.style.borderLeft = '4px solid #ffc107';
                    } else if (transaction.risk_level === 'High') {
                        row.style.backgroundColor = '#f8f9fa';
                        row.style.borderLeft = '4px solid #fd7e14';
                    }
                    
                    // Create cells for all columns in order
                    const cells = [
                        `<td style="padding: 8px; border: 1px solid #dee2e6; font-weight: bold;">${transaction.transaction_id}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.transaction_date}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">$${transaction.transaction_amount.toFixed(2)}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.quantity}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.customer_age}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.account_age_days}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.payment_method}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.product_category}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.device_used}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.customer_location}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.transaction_hour}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6; font-weight: bold; color: ${transaction.is_fraudulent ? '#dc3545' : '#28a745'};">${transaction.is_fraudulent ? 'YES' : 'NO'}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.transaction_amount_log.toFixed(4)}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.amount_per_item.toFixed(4)}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.payment_method_encoded}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.product_category_encoded}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.device_used_encoded}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.is_late_night}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.is_burst_transaction}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.amount_per_age.toFixed(4)}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.amount_per_account_age.toFixed(4)}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.customer_age_band}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.high_amount_flag}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.new_account_flag}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.young_customer_flag}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.late_night_flag}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.high_quantity_flag}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.unusual_location_flag}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.amount_age_interaction}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.account_age_interaction}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.fraud_risk_score}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.rolling_avg_amount_3.toFixed(4)}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.rolling_std_amount_3.toFixed(4)}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.transaction_amount_rank.toFixed(4)}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.account_age_rank.toFixed(4)}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.amount_x_hour.toFixed(4)}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.amount_per_hour.toFixed(4)}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6; font-weight: bold;">${transaction.anomaly_score.toFixed(4)}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6; font-weight: bold; color: ${transaction.autoencoder_flagged ? '#dc3545' : '#28a745'};">${transaction.autoencoder_flagged ? 'YES' : 'NO'}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6; font-weight: bold; color: ${transaction.rf_prediction ? '#dc3545' : '#28a745'};">${transaction.rf_prediction ? 'YES' : 'NO'}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.rf_probability.toFixed(4)}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6; font-weight: bold; color: ${transaction.risk_level === 'High' ? '#dc3545' : transaction.risk_level === 'Medium' ? '#ffc107' : '#28a745'};">${transaction.risk_level}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6;">${transaction.review_priority}</td>`,
                        `<td style="padding: 8px; border: 1px solid #dee2e6; display: none;" id="feature-importance-cell-${index}">${transaction.top_features ? transaction.top_features[0]?.feature + ' (' + (transaction.top_features[0]?.importance * 100).toFixed(1) + '%)' : 'N/A'}</td>`
                    ];
                    
                    row.innerHTML = cells.join('');
                    tbody.appendChild(row);
                });
                
                // Populate global feature importance
                const globalFeaturesDiv = document.getElementById('global-features-all');
                globalFeaturesDiv.innerHTML = '';
                
                data.feature_importance_summary.top_global_features.forEach(feature => {
                    const featureDiv = document.createElement('div');
                    featureDiv.style.padding = '10px';
                    featureDiv.style.backgroundColor = '#f8f9fa';
                    featureDiv.style.borderRadius = '5px';
                    featureDiv.style.border = '1px solid #dee2e6';
                    featureDiv.innerHTML = `
                        <strong>${feature.feature}</strong><br>
                        <span style="color: #6c757d;">${(feature.importance * 100).toFixed(1)}% importance</span>
                    `;
                    globalFeaturesDiv.appendChild(featureDiv);
                });
                
                // Show all columns transactions section
                document.getElementById('all-columns-transactions').style.display = 'block';
                
                // Store transaction data for feature importance toggle
                window.transactionData = data.transactions;
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('error-message').textContent = `Error: ${error.message}`;
                document.getElementById('error').classList.add('show');
            } finally {
                // Hide loading
                document.getElementById('loading').classList.remove('show');
            }
        }

        function toggleFeatureImportance() {
            const featureImportanceHeader = document.getElementById('feature-importance-header');
            const allColumnsTable = document.getElementById('all-columns-table');
            const button = document.getElementById('feature-importance-btn');

            if (featureImportanceHeader.style.display === 'none') {
                // Show feature importance column
                featureImportanceHeader.style.display = 'table-cell';
                allColumnsTable.style.minWidth = '2200px'; // Increase table width
                button.textContent = 'üß† Hide Feature Importance';
                button.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
                
                // Show all feature importance cells
                for (let i = 0; i < window.transactionData.length; i++) {
                    const cell = document.getElementById(`feature-importance-cell-${i}`);
                    if (cell) {
                        cell.style.display = 'table-cell';
                    }
                }
            } else {
                // Hide feature importance column
                featureImportanceHeader.style.display = 'none';
                allColumnsTable.style.minWidth = '2000px'; // Reset table width
                button.textContent = 'üß† Show Feature Importance';
                button.style.background = 'linear-gradient(45deg, #e67e22, #f39c12)';
                
                // Hide all feature importance cells
                for (let i = 0; i < window.transactionData.length; i++) {
                    const cell = document.getElementById(`feature-importance-cell-${i}`);
                    if (cell) {
                        cell.style.display = 'none';
                    }
                }
            }
        }
    </script>
</body>
</html> 